# 07. Private VLANs (PVLANs)

Hi There :) 

This lab continues the ccnp security series by introducing Private VLANs on two switches. The goal is to provide host isolation and granular east-west control while keeping a single IP subnet. 

---
Private VLANs allow you to subdivide a single Layer 2 broadcast domain into smaller, policy-enforced segments. You preserve one primary VLAN and carve out multiple secondary VLANs, each with distinct communication rules.

- Primary VLAN  
  The parent VLAN that carries L3 services and ties secondary VLANs together.

- Secondary VLANs  
  - Community VLAN: hosts in the same community can talk to each other and to promiscuous ports, but not to other communities.  
  - Isolated VLAN: hosts cannot talk to each other at Layer 2 and can only reach promiscuous ports.

- Port roles  
  - Host (also called isolated or community host): belongs to a specific secondary VLAN.  
  - Promiscuous: can reach all secondary VLANs and is typically where the default gateway or shared services live.

Traffic behavior matrix

| Source      | Destination            | Allowed |
|-------------|------------------------|---------|
| Isolated    | Isolated (same sec)    | No      |
| Isolated    | Community              | No      |
| Isolated    | Promiscuous            | Yes     |
| Community A | Community A            | Yes     |
| Community A | Community B            | No      |
| Community   | Promiscuous            | Yes     |

In this lab:
- Primary VLAN is 100.  
- Secondary VLANs are 200 (Community A), 300 (Community B), and 400 (Isolated).  
- Each switch has an SVI for VLAN 100.  
- The PVLAN trunking between switches is done using a standard 802.1Q trunk that allows VLANs 1, 100, 200, 300, and 400.  
- SW1 provides DHCP for the 10.100.0.0/24 subnet.

---

## Topology at a glance

- SW1 connected to SW2 on interface G0/0 on both ends.  
- Host ports grouped as:
  - G0/1–2 for Community A (secondary VLAN 200)  
  - G1/1–2 for Community B (secondary VLAN 300)  
  - G2/1–2 for Isolated VLAN (secondary VLAN 400)  
- SVI on SW1: Vlan100 with IP 10.100.0.1/24  
- SVI on SW2: Vlan100 with IP 10.100.0.2/24  
- DHCP service on SW1 for 10.100.0.0/24 with 10.100.0.1–10.100.0.50 excluded

![Topology](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/01.Topology%20Diagram.png)

---

## Global base configuration (on both SW1 and SW2)

```bash
spanning-tree mode rapid-pvst
vtp mode transparent
````

Explanation

* `spanning-tree mode rapid-pvst` enables Rapid PVST for faster convergence per VLAN.
* `vtp mode transparent` prevents unintended VLAN database changes from other VTP domains and lets you create VLANs locally.

Verification

```bash
show spanning-tree summary
```

![STP summary](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/02.Spanning-tree-sumary.png)

```bash
show vtp status
```

![VTP status](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/03VTP-Status.png)

---

## Define PVLANs and associations (on both SW1 and SW2)

```bash
vlan 200
 name Community A
 private-vlan community

vlan 300
 name Community B
 private-vlan community

vlan 400
 name Isolated VLAN
 private-vlan isolated

vlan 100
 name Primary VLAN
 private-vlan primary
 private-vlan association 200,300,400
```

Explanation

* `private-vlan community` and `private-vlan isolated` mark secondary VLANs.
* `private-vlan primary` defines VLAN 100 as the parent.
* `private-vlan association 200,300,400` binds the secondary VLANs to the primary.

Verification

```bash
show vlan private-vlan
```

![show vlan private-vlan](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/04.vlan-private-vlan.png)

---

## Inter-switch trunk (standard 802.1Q trunk on G0/0, both switches)

```bash
interface GigabitEthernet0/0
 switchport trunk encapsulation dot1q
 switchport mode trunk
 switchport trunk allowed vlan 1,100,200,300,400
```

Explanation

* Enables 802.1Q trunking and limits allowed VLANs to only the VLANs used in this design.
* Standard trunk is retained as requested.

Verification

```bash
show interfaces trunk
```

![ show interfaces trunk](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/05.Interfaces-trunk.png)

---

## L3 gateway SVI and PVLAN mapping

### On SW1

```bash
interface Vlan100
 no shutdown
 private-vlan mapping add 200,300,400
 ip address 10.100.0.1 255.255.255.0
```

### On SW2

```bash
interface Vlan100
 no shutdown
 private-vlan mapping add 200,300,400
 ip address 10.100.0.2 255.255.255.0
```

Explanation

* `private-vlan mapping add 200,300,400` maps the secondary VLANs to the primary SVI so that hosts in communities and isolated VLAN can reach the gateway.
* Each switch has its own SVI IP in the same subnet, per your design.

Verification

```bash
show running-config interface vlan 100
```

![SVI configuration](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/06.running-config-interface.png)

---

## Host port roles and associations

### Community A hosts (G0/1–2)

```bash
interface range GigabitEthernet0/1 - 2
 switchport mode private-vlan host
 switchport private-vlan host-association 100 200
```

### Community B hosts (G1/1–2)

```bash
interface range GigabitEthernet1/1 - 2
 switchport mode private-vlan host
 switchport private-vlan host-association 100 300
```

### Isolated hosts (G2/1–2)

```bash
interface range GigabitEthernet2/1 - 2
 switchport mode private-vlan host
 switchport private-vlan host-association 100 400
```

Explanation

* `switchport mode private-vlan host` sets the port as a PVLAN host port.
* `switchport private-vlan host-association 100 <sec>` ties the port to the primary VLAN 100 and the specific secondary VLAN for that group.

Verification

```bash
show interfaces gigabitEthernet0/1 switchport
```

![ G0/1 switchport detail](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/07.gig01-switchport.png)

---

## DHCP on SW1 for 10.100.0.0/24

```bash
ip dhcp excluded-address 10.100.0.1 10.100.0.50
ip dhcp pool MYPOOL
 network 10.100.0.0 255.255.255.0
```

Explanation

* Reserves 10.100.0.1–10.100.0.50 from dynamic assignment.
* Creates a pool for the 10.100.0.0/24 network to serve addressing to PVLAN hosts.

Verification

```bash
show ip dhcp binding
```

![DHCP bindings](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/08.ip-binding.png)

---

## End-to-end functional tests

These tests validate PVLAN behavior. Use two sample hosts per group, one on SW1 and one on SW2, if available.

1. Community A to gateway

   * From a Community A host, ping 10.100.0.1.
     Expected: Success

![ping Community A to gateway](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/09.CommunityA-to-Promiscous.png)

2. Community A to Community A across switches

   * From a Community A host on SW1, ping a Community A host on SW2.
     Expected: Success
     
![ping Community A cross-switch](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/10.Community-A-to-A.png)

3. Community A to Community B

   * From a Community A host, ping a Community B host.
     Expected: Fail
     
![ping Community A to Community B](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/11.Community-A-to-B.png)

4. Isolated to Isolated

   * From an Isolated host on SW1, ping an Isolated host on SW2.
     Expected: Fail
     
![ping Isolated to Isolated](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/12.Isolated-to-Isolated.png)

5. Isolated to gateway

   * From an Isolated host, ping 10.100.0.1.
     Expected: Success
     
![ping Isolated to gateway](https://github.com/RouteSeeker/CCNP_Security/blob/main/assets/screenshots/07.Private%20VLANs/13.Isolated-to-Promiscious.png)

---

## Notes and assumptions

* The design intentionally keeps both SVI Vlan100 interfaces up on SW1 and SW2 with 10.100.0.1/24 and 10.100.0.2/24. 
* Standard 802.1Q trunking is used rather than PVLAN-specific trunk modes, per your instruction.
* DHCP runs on SW1 and serves the entire 10.100.0.0/24 subnet.
* No additional hardening features are added in this article since they were handled in the previous lab.

---

## What We Have Learnt

In this lab we built a Private VLAN setup across two switches while preserving a single subnet. We saw how PVLANs allow segmentation of traffic into community and isolated groups, all tied back to a primary VLAN and a common gateway. We configured port roles, trunking, and DHCP integration, then tested behavior between hosts to confirm that communication rules worked as intended.  

The main takeaways are:  
- PVLANs give more granular Layer 2 security and control without needing multiple subnets.  
- Community VLANs allow limited grouping, while isolated VLANs enforce strict one-to-gateway communication.  

This lab demonstrates how campus switch security can be extended beyond traditional VLAN segmentation.  

In the next lab, we will shift from PVLANs and begin exploring **VRF-Lite**, another tool for traffic separation that operates at Layer 3.

Never stop learning!
```
